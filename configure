#!/bin/bash

# if the mysql-data directory doesn't exist yet, make it and copy the default over
# the reason we do this is because the /home/ is the only thing that persists 
# when the environment shuts down, so we store our data in our home directory
if [ ! -d "/home/embold/mysql-data" ] 
then
  mkdir /home/embold/mysql-data
  sudo chown -R mysql:mysql /home/embold/mysql-data
  sudo cp -R -p /var/lib/mysql/* /home/embold/mysql-data
else
  echo "MySQL directory already exists."
fi

sudo chown -R mysql:root /var/run/mysqld

# find and replace this comment with the port number since it seemed 
# the only safe thing to be sure was there
sudo sed -i 's/#\ socket\ location/port=3306/g' /etc/mysql/mariadb.conf.d/50-client.cnf

# find and replace the old data directories in the config files
sudo sed -i 's/var\/run\/mysqld/home\/embold\/mysql-data/g' /etc/mysql/mariadb.conf.d/50-client.cnf

sudo sed -i 's/run\/mysqld\/mysqld\.sock/home\/embold\/mysql-data\/mysqld\.sock/g' /etc/mysql/mariadb.conf.d/50-server.cnf

sudo find /etc/php/. -type f -name "php.ini" -print -exec sudo sed -i "s/mysqli.default_socket\ =/mysqli.default_socket\ =\/home\/embold\/mysql-data\/mysqld\.sock/g" {} \;

sudo find /etc/php/. -type f -name "php.ini" -print -exec sudo sed -i "s/max_execution_time\ =\ 30/max_execution_time\ =\ 3000/g" {} \;

sudo find /etc/php/. -type f -name "php.ini" -print -exec sudo sed -i "s/max_input_time\ =\ 60/max_input_time\ =\ 3000/g" {} \;

sudo find /etc/php/. -type f -name "php.ini" -print -exec sudo sed -i "s/memory_limit\ =\ 128M/memory_limit\ =\ 1128M/g" {} \;

sudo find /etc/php/. -type f -name "php.ini" -print -exec sudo sed -i "s/post_max_size\ =\ 8M/post_max_size\ =\ 800M/g" {} \;

sudo find /etc/php/. -type f -name "php.ini" -print -exec sudo sed -i "s/upload_max_filesize\ =\ 2M/upload_max_filesize\ =\ 2000M/g" {} \;

sudo find /etc/php/. -type f -name "php.ini" -print -exec sudo sed -i "s/max_file_uploads\ =\ 20/max_file_uploads\ =\ 300/g" {} \;

sudo find /etc/php/. -name 'xdebug.ini'|xargs sudo sed -i '$a\xdebug.mode=debug'

sudo find /etc/php/. -name 'xdebug.ini'|xargs sudo sed -i '$a\xdebug.start_with_request=yes'

sudo find /etc/php/. -name 'xdebug.ini'|xargs sudo sed -i '$a\xdebug.remote_enable=1'

sudo find /etc/php/. -name 'xdebug.ini'|xargs sudo sed -i '$a\xdebug.remote_autostart=1'

sudo sed -i 's/var\/lib\/mysql/home\/embold\/mysql-data/g' /etc/mysql/mariadb.conf.d/50-server.cnf

sudo sed -i 's/AllowOverride\ None/AllowOverride\ All/g' /etc/apache2/apache2.conf

sudo sed -i 's/var\/www/home\/embold\/code/g' /etc/apache2/apache2.conf

sudo sed -i 's/var\/www\/html/home\/embold\/code\/public/g' /etc/apache2/sites-available/000-default.conf

sudo sed -i 's/var\/www\/html/home\/embold\/code\/public/g' /etc/apache2/sites-available/default-ssl.conf

sudo sed -i 's/#\ Global\ configuration/ServerName\ local/g' /etc/apache2/apache2.conf

sudo nohup /mysql.sh > /dev/null 2>&1 &

if [ ! -d "/home/embold/initialized" ] 
then
  sudo sleep 10

  sudo mysql -e "CREATE USER 'homestead'@'localhost' IDENTIFIED BY 'secret';"

  sudo mysql -e "GRANT ALL PRIVILEGES ON * . * TO 'homestead'@'localhost';"

  sudo mysql -e "CREATE USER 'embold'@'localhost' IDENTIFIED BY 'embold';"

  sudo mysql -e "GRANT ALL PRIVILEGES ON * . * TO 'embold'@'localhost';"

  sudo mysql -e "FLUSH PRIVILEGES;"

  mkdir ~/initialized
fi

if [ ! -d "/home/embold/pulsar" ] 
then
  ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts 
  ssh-keyscan -t rsa embold.net >> ~/.ssh/known_hosts

  git clone git@github.com:emboldagency/pulsar.git /home/embold/pulsar
  mkdir /home/embold/.pulsar && touch /home/embold/.pulsar/config
  echo 'PULSAR_CONF_REPO="git@github.com:emboldagency/pulsar.git"' >> /home/embold/.pulsar/config
fi

if [ ! -d "/home/embold/browsersync" ]
then
  git clone git@github.com:emboldagency/backend-browsersync.git /home/embold/browsersync
fi

sudo rm /etc/sysctl.d/watches.conf
sudo touch /etc/sysctl.d/watches.conf
sudo bash -c 'echo "fs.inotify.max_user_watches = 10485760" > /etc/sysctl.d/watches.conf'

sh /install-composer.sh

curl https://getmic.ro | bash
sudo mv micro /usr/bin
